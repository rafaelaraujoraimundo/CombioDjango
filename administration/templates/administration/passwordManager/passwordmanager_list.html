{% extends "menu/index.html" %}
{% block content %}
<div class="container-fluid">
  <div class="mb-4">
    <a href="{% url 'administration_passwordmanager_new' %}" class="btn btn-primary">
      <i class="fa fa-plus"></i> Adicionar Senhas
    </a>
  </div>

  {% for grupo in PasswordGroups %}
  <div class="iq-card">
    <div class="card-body">
      <h5 class="card-title">{{ grupo.nome }}</h5>
      <div class="row mt-2">
        {% for password_manager in grupo.passwords.all %}
        <div class="col-md-4">
          <div class="card mb-4 mt-4 shadow-sm bg-password-card">
            <div class="card-body">
              <div class="iq-box-absolute icon iq-icon-box rounded-circle iq-bg-primary" style="top: 10px; right: 10px;">
                <i class="ri-key-2-fill"></i>
              </div>
              <h5 class="card-title">{{ password_manager.site_name }}</h5>
              <p class="card-text">Username: {{ password_manager.username }}</p>
              <p class="card-text">URL: <a href="{{ password_manager.url }}" target="_blank">{{ password_manager.url }}</a></p>
              <p class="card-text">Tipo: {{ password_manager.tipo }}</p>

              <!-- Botão para copiar a senha -->
              <button onclick="copyPassword({{ password_manager.id }})" class="btn btn-success btn-sm">Copiar Senha</button>

              <!-- Botão para abrir o modal de visualização -->
              <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#ModalView{{ password_manager.id }}">
                Ver Detalhes
              </button>

              <!-- Botão para abrir o modal de edição -->
              <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#ModalEdit{{ password_manager.id }}">
                Editar
              </button>

              <!-- Botão para abrir o modal de inativação -->
              <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#InactivateModal{{ password_manager.id }}">
                Inativar
              </button>
            </div>
          </div>
        </div>

        <!-- Modal de visualização -->
        <div class="modal fade" id="ModalView{{ password_manager.id }}" tabindex="-1" role="dialog" aria-labelledby="ModalLabel{{ password_manager.id }}" aria-hidden="true">
          <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="ModalLabel{{ password_manager.id }}">Detalhes do Site: {{ password_manager.site_name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="siteName{{ password_manager.id }}">Programa / Site</label>
                    <input type="text" class="form-control" id="siteName{{ password_manager.id }}" value="{{ password_manager.site_name }}" readonly>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="url{{ password_manager.id }}">URL</label>
                    <input type="text" class="form-control" id="url{{ password_manager.id }}" value="{{ password_manager.url }}" readonly>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="username{{ password_manager.id }}">Usuário</label>
                    <input type="text" class="form-control" id="username{{ password_manager.id }}" value="{{ password_manager.username }}" readonly>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="password{{ password_manager.id }}">Senha</label>
                    <div class="input-group">
                      <input type="password" class="form-control" id="modal-password-field{{ password_manager.id }}" value="{{ password_manager.get_password }}" readonly>
                      <div class="input-group-append">
                        <button class="btn btn-secondary" onclick="togglePasswordVisibility({{ password_manager.id }})" type="button">Mostrar</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="tipo{{ password_manager.id }}">Tipo</label>
                    <input type="text" class="form-control" id="tipo{{ password_manager.id }}" value="{{ password_manager.tipo }}" readonly>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="grupo{{ password_manager.id }}">Grupo</label>
                    <input type="text" class="form-control" id="grupo{{ password_manager.id }}" value="{{ password_manager.grupo }}" readonly>
                  </div>
                </div>
                <div class="form-group">
                  <label for="observacoes{{ password_manager.id }}">Observações</label>
                  <textarea class="form-control" id="observacoes{{ password_manager.id }}" readonly>{{ password_manager.observacoes }}</textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal de edição -->
        <div class="modal fade" id="ModalEdit{{ password_manager.id }}" tabindex="-1" role="dialog" aria-labelledby="ModalEditLabel{{ password_manager.id }}" aria-hidden="true">
          <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="ModalEditLabel{{ password_manager.id }}">Editar Senha: {{ password_manager.site_name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form method="POST" action="{% url 'administration_passwordmanager_list' %}">
                  {% csrf_token %}
                  <input type="hidden" name="edit_password_id" value="{{ password_manager.id }}">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="siteName{{ password_manager.id }}">Programa / Site</label>
                      <input type="text" class="form-control" id="siteName{{ password_manager.id }}" name="site_name" value="{{ password_manager.site_name }}">
                    </div>
                    <div class="form-group col-md-6">
                      <label for="url{{ password_manager.id }}">URL</label>
                      <input type="text" class="form-control" id="url{{ password_manager.id }}" name="url" value="{{ password_manager.url }}">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="username{{ password_manager.id }}">Usuário</label>
                      <input type="text" class="form-control" id="username{{ password_manager.id }}" name="username" value="{{ password_manager.username }}">
                    </div>
                    <div class="form-group col-md-6">
                      <label for="password{{ password_manager.id }}">Senha</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="modal-edit-password-field{{ password_manager.id }}" name="password">
                        <div class="input-group-append">
                          <button class="btn btn-secondary" onclick="toggleEditPasswordVisibility({{ password_manager.id }})" type="button">Mostrar</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="tipo{{ password_manager.id }}">Tipo</label>
                      <select class="form-control" id="tipo{{ password_manager.id }}" name="tipo">
                        {% for tipo in tipos %}
                          <option value="{{ tipo.id }}" {% if tipo == password_manager.tipo %}selected{% endif %}>{{ tipo.nome }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="form-group col-md-6">
                      <label for="grupo{{ password_manager.id }}">Grupo</label>
                      <select class="form-control" id="grupo{{ password_manager.id }}" name="grupo">
                        {% for grupo in grupos %}
                          <option value="{{ grupo.id }}" {% if grupo == password_manager.grupo %}selected{% endif %}>{{ grupo.nome }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="observacoes{{ password_manager.id }}">Observações</label>
                    <textarea class="form-control" id="observacoes{{ password_manager.id }}" name="observacoes">{{ password_manager.observacoes }}</textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal de confirmação de inativação -->
        <div class="modal fade" id="InactivateModal{{ password_manager.id }}" tabindex="-1" role="dialog" aria-labelledby="InactivateModalLabel{{ password_manager.id }}" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="InactivateModalLabel{{ password_manager.id }}">Confirmar Inativação</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                Tem certeza de que deseja inativar o item <strong>{{ password_manager.site_name }}</strong>?
              </div>
              <div class="modal-footer">
                <form method="POST" action="{% url 'administration_passwordmanager_inactivate' password_manager.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Confirmar</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% empty %}
    <p>Nenhum grupo de senhas encontrado.</p>
  {% endfor %}
</div>

<script>
function togglePasswordVisibility(id) {
  var passwordField = document.getElementById('modal-password-field' + id);
  var buttonText = passwordField.nextElementSibling.querySelector("button");

  if (passwordField.type === "password") {
    passwordField.type = "text";
    buttonText.textContent = "Ocultar";
  } else {
    passwordField.type = "password";
    buttonText.textContent = "Mostrar";
  }
}

function copyPassword(id) {
  fetch(`/administration/passwordmanager/get-password/${id}`)
    .then(response => response.json())
    .then(data => {
      navigator.clipboard.writeText(data.decrypted_password).then(() => {
        window.location.reload();
      });
    })
    .catch(error => {
      console.error('Error copying the password:', error);
    });
}
</script>
{% endblock %}
